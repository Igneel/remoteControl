//---------------------------------------------------------------------
#include <vcl.h>
#pragma hdrstop

#include "SDIMain.h"
#include "About.h"
//---------------------------------------------------------------------
#pragma resource "*.dfm"
TSDIAppForm *SDIAppForm;


HANDLE Port; // Дескриптор порта
			   // имена портов на чтение и запись
TCHAR PortName[MAX_PATH] = TEXT("COM7");

HANDLE openPort(TCHAR * data);
HANDLE openPort(TCHAR * data)
{
HANDLE Port;   //Дескриптор COM-порта
//Открываем COM-порт
Port = CreateFile(data, //Имя COM-порта
		   GENERIC_READ|GENERIC_WRITE,
		   FILE_SHARE_READ,
		   NULL,
		   OPEN_EXISTING,
		   FILE_ATTRIBUTE_NORMAL,
		   NULL);
if (Port == INVALID_HANDLE_VALUE)
{
	MessageBox(NULL, TEXT("Невозможно открыть последовательный порт"), TEXT("Error"), MB_OK);
	return 0;
}

//Получаем состояние управляющей структуры COM-порта,
//если не удалось выводим сообщение об ошибке и выходим из
//обработчика
COMMCONFIG comm;
GetCommState(Port, &comm.dcb);

//Настраиваем управляющую структуру COM-порта
comm.dcb.BaudRate=CBR_9600;
comm.dcb.ByteSize = 8;        //Размер байта
comm.dcb.Parity = NOPARITY;    //Паритет отключен
comm.dcb.StopBits = ONESTOPBIT;//Один стоповый бит
//Можно также воспользоваться стандартным диалоговым
//окном настройки управляющей структуры COM-порта:
CommConfigDialog(data,NULL,&comm);

//Применяем настроенную структуру к COM-порту, если не
//удалось выводим сообщение об ошибке
if(!SetCommState(Port, &comm.dcb))
{
	MessageBox(NULL, TEXT("Невозможно сконфигурировать последовательный порт"), TEXT("Error"), MB_OK);
	CloseHandle(Port);
	return 0;

}

//Получаем текущие настройки тайм-аутов COM-порта
COMMTIMEOUTS commTimeouts;
GetCommTimeouts(Port, &commTimeouts);

//Перенастраиваем тайм-ауты:
//Максимальный интервал чтения в миллисекундах между
//двумя принимаемыми символами
commTimeouts.ReadIntervalTimeout = 100; //100
//Константа в миллисекундах используемая для вычисления
//полного тайм-аута операции чтения
commTimeouts.ReadTotalTimeoutConstant = 300; // 300
//Множитель используемый для вычисления полного тайм-аута
//операции чтения в миллисекундах
commTimeouts.ReadTotalTimeoutMultiplier = 50;      //50
//Полный максимальный тайм-аут операции чтения
//вычисляется следующим образом //ReadTotalTimeoutConstant + (ReadIntervalTimeout * количество считываемых байт)

//Устанавливаем тайм-ауты для COM-порта
if(!SetCommTimeouts(Port,&commTimeouts))
{
	MessageBox(NULL, TEXT("Невозможно настроить тайм-ауты последовательного порта"), TEXT("Error"), MB_OK);
	CloseHandle(Port);
	return 0;
}

return Port;
}

//---------------------------------------------------------------------
__fastcall TSDIAppForm::TSDIAppForm(TComponent *AOwner)
	: TForm(AOwner)
{
}
//---------------------------------------------------------------------

void __fastcall TSDIAppForm::FileNew1Execute(TObject *Sender)
{
  // Do nothing
}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::FileOpen1Execute(TObject *Sender)
{
  OpenDialog->Execute();
}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::FileSave1Execute(TObject *Sender)
{
  SaveDialog->Execute();
}
//---------------------------------------------------------------------------


void __fastcall TSDIAppForm::FileExit1Execute(TObject *Sender)
{
  Close();
}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::HelpAbout1Execute(TObject *Sender)
{
  AboutBox->ShowModal();
}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::ConnectButtonClick(TObject *Sender)
{
PortWrite=openPort(dataWrite);
if(PortWrite!=0)
Memo1->Lines->Add("Порт открыт");
PortRead=PortWrite;
//PortRead=openPort(dataRead);
//if(PortRead!=0)
//Memo1->Lines->Add("Порт 2 на чтение открыт");


}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::GetButtonClick(TObject *Sender)
{

if(PortRead)
{
DWORD feedback;
//Чтение данных можно реализовать следующим образом (лучше это делать по таймеру):


feedback = 1;
int i=0;

 char ct2=0;
char dataRead[256] = {0};
//Попытка чтения первого символа хранящегося в COM-порте
ReadFile(PortRead, &ct2, sizeof(ct2), &feedback, NULL);
if(feedback>0)
{
//Если чтение удалось продолжаем чтение пока не встретится символ #13
	do
	{

		dataRead[i] = ct2 & 111; //127
		ReadFile(PortRead, &ct2, sizeof(ct2), &feedback, NULL);
		i++;
	}
	while(feedback>0 && i<254);
	dataRead[i] = '\0';
}
if(dataRead!="\0")
{
Memo1->Lines->Add("data is:");
Memo1->Lines->Add(dataRead);
}
}
}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::SendButtonClick(TObject *Sender)
{

char data[30]={'o'};
DWORD feedback;
LONG lResult=1; //Помещаем сюда количество данных, которые
int i=0;
// необходимо передать
if((!WriteFile(PortWrite, &data[0], lResult*sizeof(data[0]), &feedback, 0) || feedback != lResult*sizeof(data[i])))
{
	CloseHandle(PortWrite);
	PortWrite = INVALID_HANDLE_VALUE;
}
//При передаче мы проверяем количество переданных байт, и вообще удалось ли выполнить передачу.

}
//---------------------------------------------------------------------------

void __fastcall TSDIAppForm::DisconnectButtonClick(TObject *Sender)
{
//И закрываем порт после работы:

if(PortWrite != INVALID_HANDLE_VALUE)
{    //Если порт открыт
	CloseHandle(PortWrite);
	PortRead= PortWrite;
}

/*if(PortRead != INVALID_HANDLE_VALUE)
{    //Если порт открыт
	CloseHandle(PortRead);
} */
}
//---------------------------------------------------------------------------






void __fastcall TSDIAppForm::Button1Click(TObject *Sender)
{
TStringList *t=new TStringList();
unsigned char data=0x00;
DWORD feedback;
unsigned char ct2=0;
LONG lResult=1; //Помещаем сюда количество данных, которые
int i=0;
for(data=0;data<255;data++)
{
 WriteFile(PortWrite, &data, lResult*sizeof(data), &feedback, 0) || feedback != lResult*sizeof(data);
 ReadFile(PortRead, &ct2, sizeof(ct2), &feedback, NULL);
 Memo1->Lines->Add((unsigned int)data);
 Memo1->Lines->Add((unsigned int)ct2);
 //ReadFile(PortRead, &ct2, sizeof(ct2), &feedback, NULL);
 //Memo1->Lines->Add((unsigned int)ct2);
 }
 if(SaveDialog->Execute())
 {
t->Text=Memo1->Text;
t->SaveToFile(SaveDialog->FileName);
 }
//t->SaveToFile()

}


//---------------------------------------------------------------------------


